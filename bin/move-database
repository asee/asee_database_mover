#!/usr/bin/env ruby

require 'rubygems'
require 'trollop'
require 'yaml'
require File.join(File.dirname(File.dirname(__FILE__)),'/lib/database_mover')

SUB_COMMANDS = %w(projects move)
global_opts = Trollop::options do
  banner <<-EOS
 

Usage
-----

    database-move init
    database-move projects 

    database-move move <project> 
    database-move views <project> 

where [options] are:
EOS
  opt :dry_run, "Don't actually do anything", :short => "-n"
  opt :verbose, "Increase verbosity", :short => "-v"
  stop_on SUB_COMMANDS
end

cmd = ARGV.shift
dot = File.expand_path("~/.asee_dbs.yml")
skl = File.join(File.dirname(File.dirname(__FILE__)), 'config', 'asee_dbs.example.yml')

if File.exists?(dot)
  cnf = YAML.load(File.open(dot))
  src = ENV.has_key?('RUN_SRC') ? ENV['RUN_SRC'] : cnf['defaults']['env']['src']
  tgt = ENV.has_key?('RUN_TGT') ? ENV['RUN_TGT'] : cnf['defaults']['env']['tgt']
end


case cmd
  when "init"
    `cp #{skl} #{dot}`

  when "projects"
    puts cnf['projects']

  when "views"
    prj = ARGV.shift
    db = "#{prj}_#{src}"
    puts db
    dsn = cnf[prj][src]
    cnf['database'] = db
    dbm = ASEE::DatabaseMover.new(prj, cnf, src, tgt)
    dbm.get_view_defs

  when "dump"
    prj = ARGV.shift
    db = "#{prj}_#{src}"
    puts db
    dsn = cnf[prj][src]
    cnf['database'] = db
    dbm = ASEE::DatabaseMover.new(prj, cnf, src, tgt)
    puts dbm.dump_db

  when "fix"
    prj = ARGV.shift
    db = "#{prj}_#{src}"
    tgt = "#{prj}_#{tgt}"
    puts db
    dsn = cnf[prj][src]
    cnf['database'] = db
    dbm = ASEE::DatabaseMover.new(prj, cnf, src, tgt)
    dbm.fix_view_def

  when "deps"
    prj = ARGV.shift
    db = "#{prj}_#{src}"
    tgt = "#{prj}_#{tgt}"
    puts db
    dsn = cnf[prj][src]
    cnf['database'] = db
    dbm = ASEE::DatabaseMover.new(prj, cnf, src, tgt)
    dbm.dump_deps

end
